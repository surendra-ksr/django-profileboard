<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProfileBoard - Django Performance Dashboard</title>

    <!-- Highcharts -->
    <script src="https://code.highcharts.com/highcharts.js"></script>
    <script src="https://code.highcharts.com/modules/exporting.js"></script>

    <!-- Bootstrap for styling -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: bold;
        }

        .metric-label {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .request-table {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #ffc107; }

        #connection-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        .connected { background-color: #28a745; color: white; }
        .disconnected { background-color: #dc3545; color: white; }
    </style>
</head>
<body>
    <div id="connection-status" class="disconnected">Connecting...</div>

    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <h1 class="my-4">ProfileBoard Dashboard</h1>

                <!-- Controls -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-primary" onclick="toggleProfiler()">
                                <span id="profiler-status">Toggle Profiler</span>
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="exportData()">
                                Export Data
                            </button>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="input-group">
                            <select class="form-select" id="time-range">
                                <option value="1h">Last Hour</option>
                                <option value="24h">Last 24 Hours</option>
                                <option value="7d">Last 7 Days</option>
                            </select>
                            <button class="btn btn-outline-secondary" onclick="updateTimeRange()">
                                Update
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Metrics Cards -->
                <div class="row">
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="total-requests">-</div>
                            <div class="metric-label">Total Requests</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avg-response-time">-</div>
                            <div class="metric-label">Avg Response Time</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="error-rate">-</div>
                            <div class="metric-label">Error Rate</div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="metric-card">
                            <div class="metric-value" id="avg-db-queries">-</div>
                            <div class="metric-label">Avg DB Queries</div>
                        </div>
                    </div>
                </div>

                <!-- Charts -->
                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Response Time Over Time</h5>
                            <div id="response-time-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Request Volume</h5>
                            <div id="request-volume-chart"></div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Database Performance</h5>
                            <div id="db-performance-chart"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="chart-container">
                            <h5>Memory Usage</h5>
                            <div id="memory-usage-chart"></div>
                        </div>
                    </div>
                </div>

                <!-- Recent Requests Table -->
                <div class="request-table">
                    <h5>Recent Requests</h5>
                    <div class="table-responsive">
                        <table class="table table-striped" id="requests-table">
                            <thead>
                                <tr>
                                    <th>Time</th>
                                    <th>Status</th>
                                    <th>Method</th>
                                    <th>URL</th>
                                    <th>View</th>
                                    <th>Duration</th>
                                    <th>DB Queries</th>
                                    <th>Memory</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="requests-tbody">
                                <!-- Dynamic content -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Request Details Modal -->
    <div class="modal fade" id="requestDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Request Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="request-details-body">
                    <!-- Dynamic content -->
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Dashboard JavaScript implementation
        class ProfileDashboard {
            constructor() {
                this.websocket = null;
                this.charts = {};
                this.isProfilerEnabled = false;
                this.initWebSocket();
                this.initCharts();
            }

            initWebSocket() {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/profileboard/`;

                this.websocket = new WebSocket(wsUrl);

                this.websocket.onopen = () => {
                    console.log('WebSocket connected');
                    document.getElementById('connection-status').textContent = 'Connected';
                    document.getElementById('connection-status').className = 'connected';
                };

                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleWebSocketMessage(data);
                };

                this.websocket.onclose = () => {
                    console.log('WebSocket disconnected');
                    document.getElementById('connection-status').textContent = 'Disconnected';
                    document.getElementById('connection-status').className = 'disconnected';

                    // Reconnect after 5 seconds
                    setTimeout(() => this.initWebSocket(), 5000);
                };

                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                };
            }

            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'initial_data':
                        this.updateDashboard(data);
                        break;
                    case 'profile_update':
                        this.addNewRequest(data.data);
                        break;
                    case 'request_history':
                        this.updateRequestsTable(data.requests);
                        break;
                    case 'request_details':
                        this.showRequestDetails(data.details);
                        break;
                    case 'profiler_toggled':
                        this.isProfilerEnabled = data.enabled;
                        this.updateProfilerButton();
                        break;
                }
            }

            initCharts() {
                // Response Time Chart
                this.charts.responseTime = Highcharts.chart('response-time-chart', {
                    chart: { type: 'line', height: 300 },
                    title: { text: null },
                    xAxis: { type: 'datetime' },
                    yAxis: { title: { text: 'Response Time (s)' } },
                    series: [{
                        name: 'Response Time',
                        data: [],
                        color: '#667eea'
                    }],
                    credits: { enabled: false },
                    legend: { enabled: false }
                });

                // Request Volume Chart
                this.charts.requestVolume = Highcharts.chart('request-volume-chart', {
                    chart: { type: 'column', height: 300 },
                    title: { text: null },
                    xAxis: { type: 'datetime' },
                    yAxis: { title: { text: 'Requests/min' } },
                    series: [{
                        name: 'Requests',
                        data: [],
                        color: '#764ba2'
                    }],
                    credits: { enabled: false },
                    legend: { enabled: false }
                });

                // Database Performance Chart
                this.charts.dbPerformance = Highcharts.chart('db-performance-chart', {
                    chart: { type: 'scatter', height: 300 },
                    title: { text: null },
                    xAxis: { title: { text: 'DB Queries Count' } },
                    yAxis: { title: { text: 'DB Query Time (s)' } },
                    series: [{
                        name: 'Requests',
                        data: [],
                        color: '#28a745'
                    }],
                    credits: { enabled: false },
                    legend: { enabled: false }
                });

                // Memory Usage Chart
                this.charts.memoryUsage = Highcharts.chart('memory-usage-chart', {
                    chart: { type: 'area', height: 300 },
                    title: { text: null },
                    xAxis: { type: 'datetime' },
                    yAxis: { title: { text: 'Memory Usage (MB)' } },
                    series: [{
                        name: 'Memory',
                        data: [],
                        color: '#ffc107',
                        fillOpacity: 0.3
                    }],
                    credits: { enabled: false },
                    legend: { enabled: false }
                });
            }

            updateDashboard(data) {
                // Update metrics
                const stats = data.stats;
                document.getElementById('total-requests').textContent = stats.total_requests || 0;
                document.getElementById('avg-response-time').textContent =
                    stats.avg_duration ? `${stats.avg_duration.toFixed(3)}s` : '-';
                document.getElementById('error-rate').textContent =
                    stats.error_count ? `${((stats.error_count / stats.total_requests) * 100).toFixed(1)}%` : '0%';
                document.getElementById('avg-db-queries').textContent =
                    stats.avg_db_queries ? stats.avg_db_queries.toFixed(1) : '-';

                // Update requests table
                this.updateRequestsTable(data.recent_requests);

                // Update charts with historical data
                this.updateChartsWithData(data.recent_requests);
            }

            updateChartsWithData(requests) {
                if (!requests) return;

                // Response time data
                const responseTimeData = requests.map(req => [
                    new Date(req.timestamp).getTime(),
                    req.duration
                ]).sort((a, b) => a[0] - b[0]);

                this.charts.responseTime.series[0].setData(responseTimeData);

                // Memory usage data
                const memoryData = requests
                    .filter(req => req.memory_usage)
                    .map(req => [
                        new Date(req.timestamp).getTime(),
                        req.memory_usage
                    ]).sort((a, b) => a[0] - b[0]);

                this.charts.memoryUsage.series[0].setData(memoryData);

                // DB performance scatter
                const dbData = requests.map(req => [
                    req.db_queries_count,
                    req.db_queries_time
                ]);

                this.charts.dbPerformance.series[0].setData(dbData);
            }

            updateRequestsTable(requests) {
                const tbody = document.getElementById('requests-tbody');
                tbody.innerHTML = '';

                requests.forEach(request => {
                    const row = document.createElement('tr');

                    const statusClass = request.is_error ? 'status-error' :
                                       request.duration > 1 ? 'status-warning' : 'status-success';

                    row.innerHTML = `
                        <td>${new Date(request.timestamp).toLocaleTimeString()}</td>
                        <td><span class="status-indicator ${statusClass}"></span>${request.status_code}</td>
                        <td><span class="badge bg-secondary">${request.method}</span></td>
                        <td class="text-truncate" style="max-width: 200px;" title="${request.url}">${request.url}</td>
                        <td>${request.view_name}</td>
                        <td>${request.duration.toFixed(3)}s</td>
                        <td>${request.db_queries_count}</td>
                        <td>${request.memory_usage ? `${request.memory_usage.toFixed(1)}MB` : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="dashboard.showRequestDetails('${request.id}')">
                                Details
                            </button>
                        </td>
                    `;

                    tbody.appendChild(row);
                });
            }

            addNewRequest(requestData) {
                // Add new point to response time chart
                this.charts.responseTime.series[0].addPoint([
                    new Date(requestData.timestamp).getTime(),
                    requestData.duration
                ], true, this.charts.responseTime.series[0].data.length > 50);

                // Add to memory chart if data available
                if (requestData.memory_usage) {
                    this.charts.memoryUsage.series[0].addPoint([
                        new Date(requestData.timestamp).getTime(),
                        requestData.memory_usage
                    ], true, this.charts.memoryUsage.series[0].data.length > 50);
                }

                // Update DB performance chart
                this.charts.dbPerformance.series[0].addPoint([
                    requestData.db_queries_count,
                    requestData.db_queries_time
                ], true, this.charts.dbPerformance.series[0].data.length > 100);

                // Add to requests table (prepend to top)
                const tbody = document.getElementById('requests-tbody');
                if (tbody.children.length > 0) {
                    const newRow = document.createElement('tr');

                    const statusClass = requestData.is_error ? 'status-error' :
                                       requestData.duration > 1 ? 'status-warning' : 'status-success';

                    newRow.innerHTML = `
                        <td>${new Date(requestData.timestamp).toLocaleTimeString()}</td>
                        <td><span class="status-indicator ${statusClass}"></span>${requestData.status_code}</td>
                        <td><span class="badge bg-secondary">${requestData.method}</span></td>
                        <td class="text-truncate" style="max-width: 200px;" title="${requestData.url}">${requestData.url}</td>
                        <td>${requestData.view_name}</td>
                        <td>${requestData.duration.toFixed(3)}s</td>
                        <td>${requestData.db_queries_count}</td>
                        <td>${requestData.memory_usage ? `${requestData.memory_usage.toFixed(1)}MB` : '-'}</td>
                        <td>
                            <button class="btn btn-sm btn-outline-primary" onclick="dashboard.showRequestDetails('${requestData.profile_id}')">
                                Details
                            </button>
                        </td>
                    `;

                    tbody.insertBefore(newRow, tbody.firstChild);

                    // Remove last row if more than 50 rows
                    if (tbody.children.length > 50) {
                        tbody.removeChild(tbody.lastChild);
                    }
                }
            }

            showRequestDetails(requestId) {
                this.websocket.send(JSON.stringify({
                    type: 'request_details',
                    request_id: requestId
                }));
            }

            displayRequestDetails(details) {
                const modalBody = document.getElementById('request-details-body');

                let queriesHtml = '';
                if (details.database_queries && details.database_queries.length > 0) {
                    queriesHtml = `
                        <h6>Database Queries (${details.database_queries.length})</h6>
                        <div class="accordion" id="queriesAccordion">
                    `;

                    details.database_queries.forEach((query, index) => {
                        queriesHtml += `
                            <div class="accordion-item">
                                <h2 class="accordion-header" id="heading${index}">
                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse${index}">
                                        <strong>${query.duration.toFixed(3)}s</strong>&nbsp;&nbsp;${query.sql.substring(0, 60)}...
                                    </button>
                                </h2>
                                <div id="collapse${index}" class="accordion-collapse collapse" data-bs-parent="#queriesAccordion">
                                    <div class="accordion-body">
                                        <strong>SQL:</strong>
                                        <pre><code>${query.sql}</code></pre>
                                        <strong>Duration:</strong> ${query.duration.toFixed(3)}s<br>
                                        <strong>Parameters:</strong>
                                        <pre><code>${JSON.stringify(query.params, null, 2)}</code></pre>
                                        ${query.stack_trace ? `<strong>Stack Trace:</strong><pre><code>${query.stack_trace}</code></pre>` : ''}
                                    </div>
                                </div>
                            </div>
                        `;
                    });

                    queriesHtml += '</div>';
                }

                modalBody.innerHTML = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Request Information</h6>
                            <table class="table table-sm">
                                <tr><td><strong>URL:</strong></td><td>${details.url}</td></tr>
                                <tr><td><strong>Method:</strong></td><td>${details.method}</td></tr>
                                <tr><td><strong>View:</strong></td><td>${details.view_name}</td></tr>
                                <tr><td><strong>Status:</strong></td><td>${details.status_code}</td></tr>
                                <tr><td><strong>Duration:</strong></td><td>${details.duration.toFixed(3)}s</td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>Performance Metrics</h6>
                            <table class="table table-sm">
                                <tr><td><strong>Memory Usage:</strong></td><td>${details.memory_usage ? `${details.memory_usage.toFixed(1)}MB` : 'N/A'}</td></tr>
                                <tr><td><strong>DB Queries:</strong></td><td>${details.database_queries ? details.database_queries.length : 0}</td></tr>
                                <tr><td><strong>API Calls:</strong></td><td>${details.api_calls ? details.api_calls.length : 0}</td></tr>
                                <tr><td><strong>Timestamp:</strong></td><td>${new Date(details.timestamp).toLocaleString()}</td></tr>
                            </table>
                        </div>
                    </div>
                    ${queriesHtml}
                `;

                new bootstrap.Modal(document.getElementById('requestDetailsModal')).show();
            }

            toggleProfiler() {
                this.websocket.send(JSON.stringify({
                    type: 'toggle_profiler',
                    enabled: !this.isProfilerEnabled
                }));
            }

            updateProfilerButton() {
                const button = document.getElementById('profiler-status');
                button.textContent = this.isProfilerEnabled ? 'Disable Profiler' : 'Enable Profiler';
                button.parentElement.className = this.isProfilerEnabled ?
                    'btn btn-success' : 'btn btn-outline-primary';
            }

            exportData() {
                const timeRange = document.getElementById('time-range').value;
                window.open(`/__monitor__/export/?time_range=${timeRange}&format=csv`);
            }

            updateTimeRange() {
                const timeRange = document.getElementById('time-range').value;
                this.websocket.send(JSON.stringify({
                    type: 'request_history',
                    params: { time_range: timeRange }
                }));
            }
        }

        // Initialize dashboard
        const dashboard = new ProfileDashboard();

        // Global functions for button clicks
        function toggleProfiler() { dashboard.toggleProfiler(); }
        function exportData() { dashboard.exportData(); }
        function updateTimeRange() { dashboard.updateTimeRange(); }
    </script>
</body>
</html>